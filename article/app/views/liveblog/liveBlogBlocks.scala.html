@import model.liveblog.BodyBlock
@import model.Article
@import org.joda.time.DateTimeZone
@import play.api.libs.json.Json

@(blocks: Seq[BodyBlock], article: Article, timezone: DateTimeZone, amp: Boolean = false)(implicit request: RequestHeader)

@import views.BodyCleaner
@import model.liveblog.{LiveBlogDate}

@blocks.map { block =>
    <div id="block-@block.id" class="block block--content@block.eventClass" itemprop="liveBlogUpdate" itemscope="" itemtype="http://schema.org/BlogPosting">
        <p class="block-time published-time">
            <a href="/@article.metadata.id?page=with:block-@block.id#block-@block.id" itemprop="url" class="block-time__link">
            @views.html.liveblog.dateBlock(block.publishedCreatedDate(timezone))
            </a>
        </p>
        @block.title.map { title =>
            <h2 class="block-title" itemprop="headline">@title</h2>
        }
        @block.contributors.map { contributorId =>
            @article.tags.tags.find(_.id == s"profile/$contributorId").map{ contributorTag =>
                @views.html.fragments.meta.bylineLiveBlockImage(contributorTag)
            }
        }
        <div class="block-elements@if(block.contributors.isEmpty){ block-elements--no-byline}" itemprop="articleBody">
        @BodyCleaner(article, block.bodyHtml, amp)
        </div>
        @block.republishedDate(timezone).map { case LiveBlogDate(republishedDate, _, ampm, gmt) =>
        <p class="block-time updated-time">Updated
            <time datetime="@republishedDate">at @ampm @gmt</time>
        </p>
        }
        @views.html.fragments.share.blockLevelSharing(s"block-${block.id}", article.sharelinks.elementShares(s"block-${block.id}", None), article.metadata.contentType, amp)
    </div>
    <div class="live-blog-amp-ad-container">
        @*
          TODO:
            edition
            se(ries)
            k(eywords)
            co(ntributord)
            bl(ogs)
        *@
        <amp-ad width="300" height="250" type="doubleclick"
        json="@Json.obj(
            "targeting" -> Json.obj(
                "url" -> request.path,
                "edition" -> "uk",
                "se" -> article.trail.tags.series.mkString(","),
                "ct" -> article.metadata.contentType,
                "p" -> "amp",
                "keywordIds" -> article.trail.tags.keywords.map(_.id).mkString(","),
                "k" -> article.trail.tags.keywords.mkString(","),
                "co" -> article.trail.tags.contributors.mkString(","),
                "bl" -> article.trail.tags.blogs.mkString(","),
                "authorIds" -> article.trail.tags.contributors.map(_.id).mkString(","),
                "section" -> article.metadata.sectionId
            )
        ).toString()"
        data-slot="/59666047/theguardian.com/@article.metadata.sectionId/@article.metadata.contentType.toLowerCase/amp">
        </amp-ad>
    </div>
}
